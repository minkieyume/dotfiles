flush ruleset

define CHIKO_PRIVE_IP = {
  192.168.8.0/24,
  192.168.100.0/24,
  100.64.0.0/10
}

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # early drop of invalid connections
        ct state invalid drop

        # allow established/related connections
        ct state { established, related } accept

        # allow from loopback
        iif lo accept
        # drop connections to lo not coming from lo
        iif != lo ip daddr 127.0.0.1/8 drop
        iif != lo ip6 daddr ::1/128 drop

        # allow icmp
        ip protocol icmp accept
        ip6 nexthdr icmpv6 accept

        ip saddr $CHIKO_PRIVE_IP tcp dport http accept
        ip saddr $CHIKO_PRIVE_IP tcp dport https accept
        ip saddr $CHIKO_PRIVE_IP tcp dport imap accept
        ip saddr $CHIKO_PRIVE_IP tcp dport imaps accept
        ip saddr $CHIKO_PRIVE_IP tcp dport smtp accept
        ip saddr $CHIKO_PRIVE_IP tcp dport smtps accept
        ip saddr $CHIKO_PRIVE_IP tcp dport ssh accept
	
	# allow dns
	ip saddr $CHIKO_PRIVE_IP udp dport 53 accept
	ip saddr $CHIKO_PRIVE_IP tcp dport 53 accept

	# NFS
	ip saddr $CHIKO_PRIVE_IP udp dport 2049 accept
	ip saddr $CHIKO_PRIVE_IP tcp dport 2049 accept

	# PhoDav
	ip saddr $CHIKO_PRIVE_IP udp dport 8990 accept
	ip saddr $CHIKO_PRIVE_IP tcp dport 8990 accept

	# Proxy
	ip saddr $CHIKO_PRIVE_IP tcp dport 7890 accept
	ip saddr $CHIKO_PRIVE_IP udp dport 7890 accept

	# NaviDrome
	ip saddr $CHIKO_PRIVE_IP tcp dport 4533 accept
	ip saddr $CHIKO_PRIVE_IP udp dport 4533 accept

	# Calibre
	ip saddr $CHIKO_PRIVE_IP tcp dport 8083 accept
	ip saddr $CHIKO_PRIVE_IP udp dport 8083 accept

	# Rsync
	ip saddr $CHIKO_PRIVE_IP tcp dport 873 accept
	ip saddr $CHIKO_PRIVE_IP udp dport 873 accept

	## 允许Syncthing
	ip saddr $CHIKO_PRIVE_IP tcp dport 8384 accept
	ip saddr $CHIKO_PRIVE_IP tcp dport 22000 accept
        ip saddr $CHIKO_PRIVE_IP udp dport 21027 accept

	## OpenDHT
	udp dport 4222 accept

	## IPFS
	ip saddr $CHIKO_PRIVE_IP tcp dport 8880 accept
	ip saddr $CHIKO_PRIVE_IP tcp dport 5001 accept
	ip saddr $CHIKO_PRIVE_IP tcp dport 4001 accept
	ip saddr $CHIKO_PRIVE_IP udp dport 4001 accept

	## Forgejo
	ip saddr $CHIKO_PRIVE_IP tcp dport 3020 accept
	ip saddr $CHIKO_PRIVE_IP tcp dport 2222 accept

        # reject everything else
        reject with icmpx type port-unreachable
    }
    chain forward {
        type filter hook forward priority 0; policy drop;
	iifname "docker0" oifname "eth0" accept
	iifname "eth0" oifname "docker0" ct state established,related accept
    }
    chain output {
        type filter hook output priority 0; policy accept;
    }
}


table inet nat {
    chain prerouting {
	type nat hook prerouting priority -100; policy accept;
    }
    chain postrouting {
	type nat hook postrouting priority 100; policy accept;
	oifname "eth0" masquerade
    }
}
