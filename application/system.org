#+TITLE: System
* 介绍
系统组件集，这套组件是Linux操作系统通用的组件。

* System
核心转换配置：
#+begin_src scheme :tangle ./system.scm :noweb yes :noweb-prefix no
(use-modules <<module>>)

<<define>>
(define (os-sys-app os)
  (operating-system
   (inherit os)
   (initrd-modules (append (list <<initrd-module>>) (operating-system-initrd-modules os)))
   (kernel-loadable-modules (append (specifications->packages (list <<kernel-loadable-module>>)) (operating-system-kernel-loadable-modules os)))
   (kernel-arguments (append (list <<kernel-argument>>) (operating-system-kernel-arguments os)))
   (privileged-programs (append (list <<privileged-program>>) (operating-system-privileged-programs os)))
   (packages (append (list <<program>>) (specifications->packages (list <<package>>)) (operating-system-packages os)))
   (services
    (append (list <<service>>) (operating-system-user-services os)))))
#+end_src

** 基础模块
#+begin_src scheme :noweb-ref module
  (gnu)
  (gnu system)
  (gnu system privilege)
  (srfi srfi-26)
  (ice-9 match)
  (gnu services sysctl)
  (gnu services admin)
  (gnu services configuration)
#+end_src

#+begin_src scheme :noweb-ref module
  (rosenthal)
#+end_src

** 基础变量
#+begin_src scheme :noweb-ref define
(define %this-dir
  (let ((f (current-filename)))
    (if f (dirname f) (getcwd))))
#+end_src

** 系统管理
负责管理系统的基础包
#+begin_src scheme :noweb-ref package
"btop" "curl" "neofetch"
#+end_src

#+begin_src scheme :noweb-ref program
(spec->pkg "hello")
#+end_src

* 基础服务
** 登陆管理
#+begin_src scheme :noweb-ref service
(service pam-limits-service-type
  	 (list
          (pam-limits-entry "*" 'both 'nofile 100000)))
#+end_src

** 网络模块
#+begin_src scheme :noweb-ref module
  (gnu services networking)
#+end_src

*** 系统网络
#+begin_src scheme :noweb-ref service
  ;; https://github.com/quic-go/quic-go/wiki/UDP-Buffer-Sizes
  (simple-service 'udp-buffer-size
    sysctl-service-type
    '(("net.core.rmem_max" . "7500000")
       ("net.core.wmem_max" . "7500000")))
  (simple-service 'ip-forward
    sysctl-service-type
    '(("net.ipv4.ip_forward" . "1")
       ("net.ipv6.conf.all.forwarding" . "1")))
#+end_src

** Fish
fish，开箱即用的终端解释器。
#+begin_src scheme :noweb-ref package
  "fish"
#+end_src

* 工具
** 通用工具
#+begin_src scheme :noweb-ref package
  "openssl"
  "rsync"
  "cryptsetup"
#+end_src

** 网络调试
#+begin_src scheme :noweb-ref package
  "bind:utils"
  "tcpdump"
#+end_src

** Git
#+begin_src scheme :noweb-ref module
  (gnu packages version-control)
#+end_src

#+begin_src scheme :noweb-ref package
  "git"
#+end_src

** Doas
Doas是比Sudo更简洁，也更为安全的提权工具。
之所以用Doas而不用Sudo，是因为Sudo通常会有一定的安全漏洞，结构也比较复杂，而Doas结构相对简单，攻击面也更少，适合不需要复杂提权配置的服务器或个人。
#+begin_src scheme :noweb-ref package
  "opendoas"
#+end_src

引入自定义的包定义的doas服务。
#+begin_src scheme :noweb-ref module
  (chiko services doas)
#+end_src

自定义doas规则：
#+begin_src scheme :noweb-ref service :noweb yes :noweb-prefix no
  (service doas-service-type
    (doas-configuration
      (rules
        (list <<doas-ruleset>>))))
#+end_src

*** Doas规则
doas规则的匹配顺序是下面的规则覆盖上面的规则，因此最上面的规则最好作为默认和根规则，而下面的规则则作为覆盖上面规则的其它额外规则。

这是最基础的规则，应用于组的规则
#+begin_src scheme :noweb-ref doas-ruleset
  (doas-rule
    (permit #t)
    (user ":wheel")
    (options '("persist" "keepenv")))
#+end_src

为root用户提供修复的环境变量补全
#+begin_src scheme :noweb-ref doas-ruleset
  (doas-rule
    (permit #t)
    (user ":wheel")
    (options '("persist"
               "setenv { http_proxy https_proxy HOME=/root XDG_CACHE_HOME=/root/.cache PATH=/run/setuid-programs:/root/.config/guix/current/bin:/run/current-system/profile/bin:/run/current-system/profile/sbin INFOPATH=/root/.config/guix/current/share/info:/run/current-system/profile/share/info GIT_EXEC_PATH=/root/.guix-profile/libexec/git-core}"))
    (as-target "root"))
#+end_src

*** 禁用sudo
为了安全，最好禁用sudo，避免sudo的漏洞影响安全性。
#+begin_src scheme :noweb-ref env
  (sudoers-file
    (plain-file "sudoers" "Defaults env_reset\ndeploy ALL=(ALL) NOPASSWD: ALL"))
#+end_src

** GPG
#+begin_src scheme :noweb-ref package
  "gnupg"
#+end_src

** IPFS
#+begin_src scheme :noweb-ref package
"kubo"
#+end_src

#+begin_src scheme :noweb-ref service
(service ipfs-service-type
         (ipfs-configuration
	   (package (spec->pkg "kubo"))
           (gateway "/ip4/0.0.0.0/tcp/8880")
           (api "/ip4/0.0.0.0/tcp/5001")))
#+end_src

** 解压
#+begin_src scheme :noweb-ref package
  "unzip"
#+end_src

* 组网
** GNU Net
#+begin_src scheme :noweb-ref package
  "gnunet"
  "gnunet-scheme"
#+end_src

** Tailscale
#+begin_src scheme :noweb-ref module
  (rosenthal services networking)
#+end_src

#+begin_src scheme :noweb-ref service
  (service tailscale-service-type)
#+end_src

* 容器
#+begin_src scheme :noweb-ref module
  (gnu services docker)
#+end_src

#+begin_src scheme :noweb-ref service
  (service containerd-service-type)
#+end_src

#+begin_src scheme :noweb-ref service
  (service docker-service-type
    (docker-configuration
      (enable-iptables? #f)))
#+end_src
